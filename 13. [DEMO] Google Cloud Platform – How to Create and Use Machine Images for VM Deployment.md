![](https://media2.dev.to/dynamic/image/width=1000,height=420,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fpr6cvaj1wery7lrl9bca.png)

## **Google Cloud Platform – Tạo và sử dụng Machine Images để triển khai VM (GCP)**

---

### Tổng quan

Trong quá trình làm việc với **Google Compute Engine (GCE)**, người quản trị thường cần sao lưu, nhân bản hoặc nhanh chóng tái tạo một máy ảo (VM) với **cấu hình và dữ liệu hoàn toàn giống nhau**. **Machine Images** là cơ chế đáp ứng hiệu quả các yêu cầu này.

Tài liệu này trình bày quy trình **tạo, sử dụng và quản lý Machine Images** trong GCP bằng cả **Google Cloud Console** và **gcloud CLI**.

---

### Bước 1: Giới thiệu

Một **Machine Image** bao gồm:

* Thuộc tính VM, metadata và quyền truy cập
* Dữ liệu từ các đĩa được gắn (persistent disks)
* Toàn bộ cấu hình VM tại thời điểm tạo image

Machine Image có thể được sử dụng để:

* Tạo VM mới
* Sao lưu VM hiện có
* Khôi phục VM khi xảy ra sự cố

---

### Bước 2: Tạo VM Instance

Trước tiên, tạo một VM làm nguồn để tạo Machine Image.

```bash
# Thiết lập Project
gcloud config set project PROJECT_ID
gcloud config set project gcpdemos

# Tạo VM Instance
gcloud compute instances create demo5-vm \
  --zone=us-central1-a \
  --machine-type=e2-micro \
  --network-interface=subnet=default \
  --tags=http-server
```

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fex8qab8x4pta1ttrmqj0.png)


![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fd3d6sj97t3aj9klfhhhs.png)
Sau khi VM được tạo, kết nối SSH (qua trình duyệt), tải lên file `webserver-install.sh` và thực thi:

```bash
#!/bin/bash
sudo apt install -y telnet
sudo apt install -y nginx
sudo systemctl enable nginx
sudo chmod -R 755 /var/www/html
HOSTNAME=$(hostname)
sudo echo "<!DOCTYPE html> <html> <body style='background-color:rgb(250, 210, 210);'> <h1>Welcome to Latchu@DevOps - WebVM App1 </h1> <p><strong>VM Hostname:</strong> $HOSTNAME</p> <p><strong>VM IP Address:</strong> $(hostname -I)</p> <p><strong>Application Version:</strong> V1</p> <p>Google Cloud Platform - Demos</p> </body></html>" | sudo tee /var/www/html/index.html
```

Thay đổi quyền và chạy script:

```bash
chmod 755 webserver-install.sh
./webserver-install.sh
```

Kiểm tra dịch vụ:

```bash
curl localhost
sudo echo "Machine Images Demo 101" | sudo tee /var/www/html/midemo.html
curl localhost/midemo.html
```
![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F3pjfqt7rcjd4toal1111.png)


Kiểm tra ứng dụng trên trình duyệt:

```
http://<external-ip-of-vm>
http://<external-ip-of-vm>/midemo.html
```

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F38jurt9yu9b4fp398uux.png)

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fgvanp521qra6ql8rz8es.png)
---

### Bước 3: Tạo Machine Image

Thực hiện trên **Google Cloud Console**:

* Truy cập **Compute Engine → VM Instances → demo5-vm**
* Chọn **Create new Machine Image**
* **Name**: `demo5-vm-machine-image`
* **Location**: Multi-regional (us)
* **Encryption**: Google-managed key (mặc định)
* Xem lại các thiết lập nâng cao và nhấn **Create**

⏳ Thời gian tạo khoảng **5–10 phút**.

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fbazy9njs2ashrm66jw50.png)

---

### Bước 4: Xác minh thuộc tính Machine Image

Truy cập:

**Compute Engine → Machine Images → demo5-vm-machine-image**

Kiểm tra các thông tin:

* Machine type
* Metadata
* Network tags
* Boot disk
* Service account
* Các cấu hình VM liên quan khác

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fuhpahf66oldz03hvooel.png)
---

### Bước 5: Tạo VM từ Machine Image

Có hai cách tạo VM từ Machine Image:

* **Cách 1**:
  **VM Instances → Create Instance → From Machine Image**

* **Cách 2**:
  **Machine Images → demo5-vm-machine-image → Actions → Create Instance**

Đặt tên VM: `demo5-vm-from-machine-image`

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fslyzf2levzxo3khyaetm.png)
---

### Bước 6: Xác minh Web Server

Truy cập các trang web của VM mới:

```
http://<external-ip-of-vm>
http://<external-ip-of-vm>/midemo.html
```
![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fxul1ja7rdljby9z6aiun.png)

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F7t21jcagdfdzuro3nvgs.png)

**Nhận xét:**

* Nội dung `index.html` và `midemo.html` được giữ nguyên như VM nguồn
* Hostname và IP private hiển thị trong trang HTML vẫn là của VM gốc (`demo5-vm`) do Machine Image là bản sao trạng thái tại thời điểm tạo
* Không cần cài đặt lại ứng dụng vì Machine Image đã lưu toàn bộ phần mềm đã cài sẵn

---

### Bước 7: Tạo Machine Image bằng gcloud CLI

```bash
# Tạo Machine Image
gcloud compute machine-images create demo5-vm-machine-image-gcloud \
  --source-instance=demo5-vm \
  --source-instance-zone=us-central1-a \
  --storage-location=us  

# Liệt kê Machine Images
gcloud compute machine-images list  

# Xóa Machine Images
gcloud compute machine-images delete demo5-vm-machine-image
gcloud compute machine-images delete demo5-vm-machine-image-gcloud
```

---

### Bước 8: Dọn dẹp tài nguyên

Dừng và xóa các VM để tránh phát sinh chi phí:

```bash
gcloud compute instances delete demo5-vm --zone us-central1-a
gcloud compute instances delete demo5-vm-from-machine-image --zone us-central1-a
```

---

### Tổng kết

* **Machine Images** lưu trữ đầy đủ **cấu hình VM và dữ liệu đĩa**
* Phù hợp cho **sao lưu, nhân bản, tái tạo môi trường và khôi phục thảm họa (DR)**
* Có thể tạo và khôi phục thông qua **Console, gcloud CLI hoặc REST API**
* Giúp **tiết kiệm thời gian** và **đảm bảo tính nhất quán** giữa các môi trường triển khai
