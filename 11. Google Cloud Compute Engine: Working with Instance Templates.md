![](https://media2.dev.to/dynamic/image/width=1000,height=420,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F785hcjth76tx9ow588n7.png)
## **Google Cloud Compute Engine: Làm việc với Instance Templates (GCP)**

---

### Tổng quan

Tài liệu này trình bày quy trình tạo và sử dụng **Instance Templates** trong **Google Cloud Compute Engine**. Instance Templates cho phép định nghĩa cấu hình máy ảo (VM) một lần và tái sử dụng nhiều lần, nhằm đảm bảo việc triển khai nhất quán, có thể lặp lại và dễ tự động hóa.

Nội dung bao gồm:

* Tạo Instance Template
* Khởi tạo VM từ Instance Template
* Sao chép (clone) Instance Template bằng chức năng *Create Similar*
* Tự động hóa việc tạo Instance Template bằng **gcloud CLI**

---

### Bước 01: Giới thiệu

Trong bài thực hành này, chúng ta sẽ thực hiện:

* Tạo một **Instance Template**
* Tạo một **VM** dựa trên Instance Template
* Sao chép Instance Template bằng tùy chọn **Create Similar**
* Tạo Instance Template thông qua **gcloud CLI**

---

### Bước 02: Tạo Instance Template
---
![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fq5qvysi6owi5o55kyr8t.png)

---

Truy cập theo đường dẫn:

**Compute Engine → Virtual Machines → Instance Templates → Create Instance Template**

Cấu hình các thông tin sau:

### 1 **Thông tin cơ bản**

* **Name**: `demo4-instance-template`
* **Location**: Regional
* **Region**: `us-central1`

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fskkzxvamw74uvvlqf14d.png)

### 2 **Machine Configuration**

* **Series**: E2
* **Machine Type**: `e2-micro`
---
### 3 **Availability Policies**

* **VM Provisioning Model**: Standard
* **Display Device**: Không chọn (mặc định)
* **Confidential VM Service**: Không chọn (mặc định)
* **Container**: Không chọn
* **Boot Disk**: Giữ nguyên cấu hình mặc định

### 4 **Identity and API Access**

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fqq2myidmbqkmtt9i46pd.png)

* **Service Account**: Compute Engine default service account
* **Access Scopes**: Allow default access

### 5 **Firewall**

* Chọn **Allow HTTP traffic**

### 6 **Advanced Options → Management**
![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fjdjoj6767scaqwvc9n4b.png)
* **Description**: `demo4-vm-startupscript`
* **Reservations**: Giữ nguyên mặc định

**Startup Script**
Sao chép và dán nội dung từ file `webserver-install.sh` như sau:

```bash
#!/bin/bash
sudo apt install -y telnet
sudo apt install -y nginx
sudo systemctl enable nginx
sudo chmod -R 755 /var/www/html
HOSTNAME=$(hostname)
sudo echo "<!DOCTYPE html> <html> <body style='background-color:rgb(250, 210, 210);'> <h1>Welcome to Latchu@DevOps - WebVM App1 </h1> <p><strong>VM Hostname:</strong> $HOSTNAME</p> <p><strong>VM IP Address:</strong> $(hostname -I)</p> <p><strong>Application Version:</strong> V1</p> <p>Google Cloud Platform - Demos</p> </body></html>" | sudo tee /var/www/html/index.html
```

### 7 Sau khi hoàn tất, nhấn **Create** để tạo Instance Template.

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fluylpau6cksrd2m4mrli.png)
---
![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fiqqekxgliyb6vvhvkm0h.png)

### Bước 03: Tạo VM Instance từ Instance Template

Có hai cách để khởi tạo VM từ Instance Template:

**Cách 1**

1. Truy cập **Compute Engine → VM Instances → Create Instance**
2. Chọn **New VM instance from template**
3. Chọn template `demo4-instance-template`
4. Nhấn **Continue**
5. Nhập tên VM: `demo4-vm-from-instance-template`
6. Kiểm tra các cấu hình được kế thừa từ template
7. Nhấn **Create**

**Cách 2**

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F9mg758fan7olpdyqspt2.png)

* Truy cập **Instance Templates → demo4-instance-template → Create VM**

---

### Bước 04: Xác minh hoạt động của Web Server

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fa0jsn66rmmvrluhg38ks.png)

Sau khi VM được khởi tạo:

* Có thể SSH vào VM để kiểm tra
* Hoặc truy cập trực tiếp qua trình duyệt:

```
http://<external-ip-of-vm>
```

---

### Bước 05: Dừng và xóa VM

Trong **VM Instances**, chọn `demo4-vm-from-instance-template` và nhấn **Delete**.

Hoặc sử dụng **gcloud CLI**:

```bash
gcloud compute instances delete demo4-vm-from-instance-template --zone us-central1-a
```

---

### Bước 06: Sao chép Instance Template bằng “Create Similar”

![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fxduvykvia1u1f0c11vxe.png)

Thực hiện:

* Truy cập **Instance Templates → demo4-instance-template → Create Similar**
* Đặt tên template mới: `demo4-instance-template-v2`
* Thực hiện các thay đổi cấu hình cần thiết
* Tạo template mới

---

### Bước 07: Tạo Instance Template bằng gcloud CLI

Tự động hóa việc tạo Instance Template bằng dòng lệnh.
Yêu cầu: file `webserver-install.sh` phải tồn tại trong thư mục home của **Cloud Shell**.

```bash
# Thiết lập Project
gcloud config set project PROJECT_ID
gcloud config set project gcplearn9

# Tạo Instance Template
gcloud compute instance-templates create demo4-it-v1 \
  --machine-type=e2-micro \
  --network-interface=network=default,network-tier=PREMIUM \
  --instance-template-region=us-central1 \
  --tags=http-server \
  --metadata-from-file=startup-script=webserver-install.sh
```
![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F33ab3mwspyrr80ejcaq0.png)

---
![](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fl7evej2neaw3awgsc7dp.png)



---

### Tổng kết

Trong tài liệu này, chúng ta đã thực hiện:

* Tạo **Instance Template** bằng Google Cloud Console
* Khởi tạo **VM** từ Instance Template
* Sao chép Instance Template bằng **Create Similar**
* Tự động hóa việc tạo Instance Template bằng **gcloud CLI**

---
